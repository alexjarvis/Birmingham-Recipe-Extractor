---
stages:
  - lint
  - test
  - build
  - deploy

php-syntax:
  stage: lint
  image: php:8.3-cli-alpine
  script:
    - find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

phpunit:
  stage: test
  image: php:8.3-cli-alpine
  before_script:
    - apk add --no-cache curl git unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-interaction --prefer-dist
  script:
    - ./vendor/bin/phpunit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Docker build using Docker-in-Docker
docker-build:
  stage: build
  image: docker:24.0
  services:
    - name: docker:24.0-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker info
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    # Push to registry if configured
    - if [ -n "$CI_REGISTRY_USER" ]; then
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY;
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA;
        docker push $CI_REGISTRY_IMAGE:latest;
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# GitLab Pages deployment - mirrors GitHub Pages from gh-pages branch
pages:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache git
    - git fetch origin gh-pages
    - git checkout origin/gh-pages -- .
    - mkdir -p public
    - cp -r archive images index.html template .nojekyll public/ 2>/dev/null || true
    - ls -la public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
