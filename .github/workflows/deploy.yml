name: Generate and Deploy Recipes

on:
  schedule:
    - cron: "0 0 * * *"  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual triggering from the Actions tab

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the gh-pages branch first
      - name: Check out the gh-pages branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages  # Ensures it checks out the gh-pages branch

      # Step 2: Preserve only necessary files to a temporary directory
      # Note: We only preserve archive HTML and images - not old product JSON files
      - name: Preserve files to temp storage
        run: |
          mkdir -p /tmp/deploy_files/archive
          mkdir -p /tmp/deploy_files/images
          if [ -d "archive" ] && [ "$(ls -A archive)" ]; then
            mv archive/* /tmp/deploy_files/archive/ 2>/dev/null || true
          fi
          if [ -d "images" ] && [ "$(ls -A images)" ]; then
            mv images/* /tmp/deploy_files/images/ 2>/dev/null || true
          fi
          if [ -f "index.html" ]; then
            mv index.html /tmp/deploy_files/index.html
          fi

      # Step 3: Check out the develop branch
      - name: Check out the develop branch
        uses: actions/checkout@v2
        with:
          ref: develop  # Switches to the develop branch

      # Step 4: Restore files from the temporary directory to output directory
      - name: Restore preserved files to output
        run: |
          if [ "$(ls -A /tmp/deploy_files/archive 2>/dev/null)" ]; then
            mv /tmp/deploy_files/archive/* output/archive/ 2>/dev/null || true
          fi
          if [ "$(ls -A /tmp/deploy_files/images 2>/dev/null)" ]; then
            mv /tmp/deploy_files/images/* output/images/ 2>/dev/null || true
          fi
          if [ -f "/tmp/deploy_files/index.html" ]; then
            mv /tmp/deploy_files/index.html output/index.html
          fi

      # Step 5: Set up PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      # Step 6: Run the PHP script to generate HTML
      - name: Run the script to generate HTML
        run: php run.php

      # Step 7: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: output
          publish_branch: gh-pages