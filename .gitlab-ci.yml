---
stages:
  - sync
  - lint
  - test
  - build
  - deploy

# =============================================================================
# GITHUB SYNC
# =============================================================================
# Requires CI/CD variables:
#   - GITHUB_REPO_URL: https://github.com/alexjarvis/repo.git (public read)
#   - GITHUB_PUSH_URL: https://alexjarvis:<TOKEN>@github.com/alexjarvis/repo.git (for push)

# Pull gh-pages from GitHub (scheduled daily)
sync-gh-pages-from-github:
  stage: sync
  image: alpine/git
  script:
    - git config --global user.email "gitlab-ci@rivendell.fivedigitinteger.com"
    - git config --global user.name "GitLab CI"
    - git remote add github "${GITHUB_REPO_URL}" || true
    - git fetch github gh-pages
    - git fetch origin gh-pages || true
    - |
      LOCAL=$(git rev-parse origin/gh-pages 2>/dev/null || echo "none")
      REMOTE=$(git rev-parse github/gh-pages 2>/dev/null || echo "none")
      echo "Local gh-pages: $LOCAL"
      echo "GitHub gh-pages: $REMOTE"
      if [ "$LOCAL" != "$REMOTE" ]; then
        echo "Changes detected - updating GitLab gh-pages branch"
        git checkout -B gh-pages github/gh-pages
        git push -f "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" gh-pages
        echo "SYNC_CHANGED=true" >> sync.env
      else
        echo "No changes detected"
        echo "SYNC_CHANGED=false" >> sync.env
      fi
  artifacts:
    reports:
      dotenv: sync.env
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Rebuild pages if gh-pages was updated
pages-after-sync:
  stage: deploy
  image: alpine:latest
  needs:
    - job: sync-gh-pages-from-github
      artifacts: true
  script:
    - apk add --no-cache git
    - git fetch origin gh-pages
    - git checkout origin/gh-pages -- .
    - mkdir -p public
    - cp -r archive images index.html template .nojekyll public/ 2>/dev/null || true
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SYNC_CHANGED == "true"

# Push main to GitHub (on commits to main)
push-main-to-github:
  stage: deploy
  image: alpine/git
  script:
    - git remote add github "${GITHUB_PUSH_URL}" || true
    - git push github HEAD:main
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"
  allow_failure: true  # Don't fail pipeline if GitHub push fails

# =============================================================================
# REGULAR CI/CD JOBS
# =============================================================================
php-syntax:
  stage: lint
  image: php:8.3-cli-alpine
  script:
    - find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

phpunit:
  stage: test
  image: php:8.3-cli-alpine
  before_script:
    - apk add --no-cache curl git unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-interaction --prefer-dist
  script:
    - ./vendor/bin/phpunit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Docker build using Docker-in-Docker
docker-build:
  stage: build
  image: docker:24.0
  services:
    - name: docker:24.0-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    # Wait for Docker daemon to be ready
    - for i in $(seq 1 30); do docker info && break || sleep 2; done
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    # Push to registry if configured
    - if [ -n "$CI_REGISTRY_USER" ]; then
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY;
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA;
        docker push $CI_REGISTRY_IMAGE:latest;
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# GitLab Pages deployment - mirrors GitHub Pages from gh-pages branch
pages:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache git
    - git fetch origin gh-pages
    - git checkout origin/gh-pages -- .
    - mkdir -p public
    - cp -r archive images index.html template .nojekyll public/ 2>/dev/null || true
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 1 hour  # Only keep latest; new deployment replaces old
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
