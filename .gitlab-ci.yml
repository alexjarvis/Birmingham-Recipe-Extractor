---
stages:
  - lint
  - test
  - deploy

php-syntax:
  stage: lint
  image: php:8.3-cli-alpine
  script:
    - find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

phpunit:
  stage: test
  image: php:8.3-cli-alpine
  before_script:
    - apk add --no-cache curl git unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-interaction --prefer-dist
  script:
    - ./vendor/bin/phpunit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

generate-test:
  stage: test
  image: php:8.3-cli-alpine
  before_script:
    - apk add --no-cache curl php-curl php-json php-dom
  script:
    - php run.php
    - test -f output/index.html || exit 1
  artifacts:
    paths:
      - output/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# GitLab Pages deployment - mirrors GitHub Pages from gh-pages branch
pages:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache git
    - git fetch origin gh-pages
    - git checkout origin/gh-pages -- .
    - mkdir -p public
    - cp -r archive images index.html template .nojekyll public/ 2>/dev/null || true
    - ls -la public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
